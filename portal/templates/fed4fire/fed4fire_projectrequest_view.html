{% extends "layout.html" %}
{% load i18n %}

{% block content %}
<br />
<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-tabs nav-section">
            <li class="active"><a href="#existing">Join existing Project</a></li>
            <li><a href="#new">Create new Project</a></li>
            
        </ul>
    </div>
</div>

{% if errors %}
<div class="row">
    <div class="col-md-12">
    <ul class="error">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    </div>
</div>
{% endif %}

<div class="container tab-content">
    
	<div class="tab-pane active" id="existing"> 
        <div class="row">
            <div class="col-md-6">
                 <h3>Join an existing Project</h3>
            </div>
            <div class="col-md-6">
                 <h3>List of projects you are part of</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <form role="form" method="post">
                {% csrf_token %}
                <select id="projects"></select> <button type="submit" class="btn">Join</button>
                </form>
            </div>
            <div class="col-md-6">
                <table class="table project-list">
                    {% for pending in pending_projects %}
                    <tr><td>(PENDING) {{ pending.project_name }}</td><td>{{ pending.authority_hrn }}</td><td>{{ pending.created|date:"d/m/Y" }}</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-pane" id="new"> 
        <div class="row">
            <div class="col-md-12">
                 <h3>Create a new Project</h3>
            </div>
        </div>
    
        
        <div class="row">
            <div class="col-md-12">
                <form role="form" method="post" action="/portal/project_request">
                {% csrf_token %}
                  <div class="form-group">
                    <input type="text" name="project_name" value="" placeholder="Name" required>
                  </div>
                  <div class="form-group">
                    <select id="org_name" name="authority_name" class="form-control" style="width:590px" value="{{ organization }}" required> 
                    {% if authorities %}
                        {% for authority in authorities %}
                            {% if authority.name %}
                                <option value="{{ authority.authority_hrn }}">{{authority.name}}</option>
                            {% else %}
                                <option value="{{ authority.authority_hrn }}">{{authority.authority_hrn}}</option>
                            {% endif %}
                        {% endfor %} 
                    {% endif %}
                    </select>
                  </div>
                  
                  
                  <div class="form-group">
                    <textarea id="purpose" name="purpose" class="form-control" rows="6" placeholder="Description" style="width:300px" title="Purpose of your project (informative)" required="required"></textarea>
                  </div>
                  <button type="submit" class="btn btn-onelab"><span class="glyphicon glyphicon-plus"></span> Send Request</button>
                </form>
        
            </div>
        </div>
    </div>
    
</div>
		
<script>
$(document).ready(function() {
    var myprojects = localStorage.getItem('projects');
    console.log(myprojects);
    if (myprojects) {
        
    } else {
        $('.project-list').html('<tr><td>no projetcs</td></tr>');
    }
    
    $('.nav-tabs a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });
    $.post("/rest/myslice:authority/",{'fields':['authority_hrn','pi_users'],'filters':{'authority_hrn':'CONTAINS{{ authority_hrn }}' }}, function( data ) {
       
        var projects = [];
        project_row = "<option value=''> - </option>";
        projects.push(project_row);
       
        $.each( data, function( key, val ) {
            console.log(val);
            project_row = "<option value='"+val.authority_hrn+"'>"+val.authority_hrn+"</option>";
            projects.push(project_row);
        });
        $("#projects").html(projects.join( "" ));
    });
/*
	
	$("#authority_hrn").load("/rest/user/", {"fields" : ["parent_authority"], "filters": {"user_hrn": "{{ user_hrn }}"}}, function(data) {
		var jsonData = JSON.parse(data);
        $(this).attr("value", jsonData[0]['parent_authority']);
    });
	$("#authority_hrn").val("{{authority_name}}");
	var availableTags = [
    {% if authorities %}
        {% for authority in authorities %}
            {% if authority.name %}
                {value:"{{ authority.name }}",label:"{{authority.name}}"},
			// to show only full name
            {% else %}
                {value:"{{ authority.authority_hrn }}",label:"{{authority.authority_hrn}}"},
            {% endif %}
        {% endfor %}    
    {% else %}
        {value:"",label:"No authority found !!!"}
    {% endif %}
    ];
	// sorting the list
	availableTags.sort(function(a,b){
		var nameA=a.value.toLowerCase(), nameB=b.value.toLowerCase();
		if (nameA < nameB) {
    		return -1;
		}
		if (nameA > nameB) {
    		return 1;
		}
	return 0;
	}); 
    $( "#authority_hrn" ).autocomplete({
      source: availableTags,
      minLength: 0,
      select: function( event, ui ) {console.log(jQuery(this));}
    });
*/
	$("#submit_pi").click(function() {
		localStorage.clear();
	});
	// auto-complete the form
    //jQuery("#org_name").combobox();

});
</script>
{% endblock %}

